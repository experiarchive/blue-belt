---
interface Props {
  routeName: string;
  stops: string[];
  departures: (string | null)[][];
}

const { routeName, stops, departures } = Astro.props;

// ìš”ì•½ ì •ë³´ ê³„ì‚°
function getSummaryData() {
  const validTimes = departures
    .flat()
    .filter(time => time && time !== 'â€”' && /^\d{2}:\d{2}$/.test(time))
    .sort();

  if (validTimes.length === 0) {
    return { firstBus: 'â€”', lastBus: 'â€”', avgInterval: 'â€”' };
  }

  const firstBus = validTimes[0];
  const lastBus = validTimes[validTimes.length - 1];
  
  // í‰ê·  ë°°ì°¨ê°„ê²© ê³„ì‚° (ë¶„ ë‹¨ìœ„)
  let totalIntervals = 0;
  let intervalCount = 0;
  
  for (let i = 1; i < validTimes.length; i++) {
    const [h1, m1] = validTimes[i-1].split(':').map(Number);
    const [h2, m2] = validTimes[i].split(':').map(Number);
    const diff = (h2 * 60 + m2) - (h1 * 60 + m1);
    if (diff > 0 && diff < 180) { // 3ì‹œê°„ ì´í•˜ ê°„ê²©ë§Œ ê³„ì‚°
      totalIntervals += diff;
      intervalCount++;
    }
  }
  
  const avgInterval = intervalCount > 0 
    ? Math.round(totalIntervals / intervalCount) + 'ë¶„'
    : 'â€”';

  return { firstBus, lastBus, avgInterval };
}

const summary = getSummaryData();
---

<!-- ìš”ì•½ ë°°ì§€ -->
<div class="mb-6 flex flex-wrap gap-3 justify-center">
  <div class="px-4 py-2 bg-gradient-to-r from-blue-50 to-blue-100 rounded-full border border-blue-200">
    <span class="text-blue-600 text-sm font-medium">
      ğŸšŒ ì²«ì°¨ <span class="font-tabular font-semibold">{summary.firstBus}</span>
    </span>
  </div>
  <div class="px-4 py-2 bg-gradient-to-r from-green-50 to-green-100 rounded-full border border-green-200">
    <span class="text-green-600 text-sm font-medium">
      ğŸŒ™ ë§‰ì°¨ <span class="font-tabular font-semibold">{summary.lastBus}</span>
    </span>
  </div>
  <div class="px-4 py-2 bg-gradient-to-r from-purple-50 to-purple-100 rounded-full border border-purple-200">
    <span class="text-purple-600 text-sm font-medium">
      âš¡ í‰ê· ë°°ì°¨ <span class="font-tabular font-semibold">{summary.avgInterval}</span>
    </span>
  </div>
</div>

<div class="timetable-container overflow-x-auto bg-white rounded-lg shadow-sm border">
  <table class="w-full min-w-full font-tabular">
    <caption class="sr-only">
      {routeName} ì •ë¥˜ì¥ë³„ ì¶œë°œì‹œê°(í˜„ì§€ KST)
    </caption>
    <thead class="bg-blue-50 sticky top-0">
      <tr>
        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900 border-r">ì¶œë°œì‹œê°</th>
        {stops.map((stop) => (
          <th class="px-3 py-3 text-center text-sm font-semibold text-gray-900 min-w-24 border-r last:border-r-0">
            {stop}
          </th>
        ))}
      </tr>
    </thead>
    <tbody>
      {departures.map((departure, index) => (
        <tr class={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
          <td class="px-4 py-3 text-sm font-medium text-gray-900 whitespace-nowrap border-r font-tabular">
            {departure[0] || 'â€”'}
          </td>
          {departure.slice(1).map((time, stopIndex) => (
            <td class="px-3 py-3 text-center text-sm text-gray-700 whitespace-nowrap border-r last:border-r-0 font-tabular">
              {time || 'â€”'}
            </td>
          ))}
        </tr>
      ))}
    </tbody>
  </table>
</div>

<style>
  .timetable-container {
    max-width: 100%;
  }
  
  table {
    border-collapse: collapse;
  }
  
  th, td {
    border-bottom: 1px solid #e5e7eb;
  }
  
  @media (max-width: 768px) {
    th, td {
      padding: 8px 12px;
      font-size: 0.875rem;
    }
    
    th {
      min-width: 80px;
    }
  }
</style>